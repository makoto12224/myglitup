<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>バス料金計算（深夜早朝 距離単価対応）</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #fff; padding: 20px; max-width: 900px; margin: auto; }
    h1 { text-align: center; font-size: 24px; }
    label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; }
    input[type="text"], input[type="number"] {
      width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;
    }
    button {
      width: 100%; padding: 10px; font-size: 18px; margin: 20px 0; cursor: pointer;
    }
    #result {
      font-size: 18px; margin-top: 20px; white-space: pre-line;
      background-color: #f0f0f0; padding: 20px; border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>バス料金計算（深夜加算 距離単価込み）</h1>

  <label>時間制料金単価（円/時間）</label>
  <input id="timeRate" type="number" inputmode="numeric" />

  <label>距離制料金単価（円/km）</label>
  <input id="distanceRate" type="number" inputmode="numeric" />

  <label>回送距離（km）</label>
  <input id="deadheadDistance" type="number" inputmode="decimal" />

  <label>実車距離（km）</label>
  <input id="realDistance" type="number" inputmode="decimal" />

  <label>出庫時間（例：2500 または 25:00）</label>
  <input id="departureTime" type="text" inputmode="numeric" />

  <label>帰庫時間（例：2930 または 29:30）</label>
  <input id="returnTime" type="text" inputmode="numeric" />

  <label><input id="hasAlternateDriver" type="checkbox" onchange="toggleAlternateDriver()"> 交代運転者あり</label>

  <div id="alternateDriverInputs" style="display:none;">
    <label>交代運転者：距離加算単価（円/km）</label>
    <input id="alternateDistanceRate" type="number" />
    <label>交代運転者：時間加算単価（円/時間）</label>
    <input id="alternateTimeRate" type="number" />
  </div>

  <button onclick="calculateBusCharge()">計算する</button>

  <div id="result">&nbsp;</div>

  <script>
    function normalizeTimeInput(raw) {
      const cleaned = raw.replace(/[^0-9]/g, '');
      if (/^\d{4}$/.test(cleaned)) {
        const hours = parseInt(cleaned.slice(0, 2), 10);
        const minutes = cleaned.slice(2);
        return `${hours}:${minutes}`;
      }
      return raw;
    }

    function parseTimeToDecimalHours(timeStr) {
      const [h, m] = timeStr.split(':').map(Number);
      return h + m / 60;
    }

    function countNightHours(startHour, endHour) {
      let count = 0;
      for (let h = Math.ceil(startHour); h < endHour; h++) {
        const hour = h % 24;
        if (hour >= 22 || hour < 6) {
          count++;
        }
      }
      return count;
    }

    function toggleAlternateDriver() {
      document.getElementById('alternateDriverInputs').style.display =
        document.getElementById('hasAlternateDriver').checked ? 'block' : 'none';
    }

    function calculateBusCharge() {
      const timeRate = Number(document.getElementById('timeRate').value);
      const distanceRate = Number(document.getElementById('distanceRate').value);
      const deadheadDistance = Number(document.getElementById('deadheadDistance').value);
      const realDistance = Number(document.getElementById('realDistance').value);
      const departureTime = normalizeTimeInput(document.getElementById('departureTime').value.trim());
      const returnTime = normalizeTimeInput(document.getElementById('returnTime').value.trim());
      const hasAltDriver = document.getElementById('hasAlternateDriver').checked;
      const altDistanceRate = hasAltDriver ? Number(document.getElementById('alternateDistanceRate').value) : 0;
      const altTimeRate = hasAltDriver ? Number(document.getElementById('alternateTimeRate').value) : 0;

      if (!timeRate || !distanceRate || !deadheadDistance || !realDistance || !departureTime || !returnTime) {
        alert('すべての項目を正しく入力してください。');
        return;
      }

      const startHour = parseTimeToDecimalHours(departureTime);
      const endHour = parseTimeToDecimalHours(returnTime);
      if (endHour <= startHour) {
        alert("帰庫時間は出庫時間より後にしてください。");
        return;
      }

      let driveHours = Math.ceil(endHour - startHour);
      driveHours += 2;
      if (driveHours < 5) driveHours = 5;

      const totalDistance = Math.ceil((deadheadDistance + realDistance) / 10) * 10;

      const timeCharge = driveHours * timeRate;
      const distanceCharge = totalDistance * distanceRate;
      const altDistanceCharge = totalDistance * altDistanceRate;
      const altTimeCharge = driveHours * altTimeRate;

      const nightHours = countNightHours(startHour, endHour);
      const nightBase = (timeRate + altDistanceRate) * nightHours; // ← 距離単価加算に修正
      const nightSurcharge = Math.floor(nightBase * 0.2);

      const total = timeCharge + distanceCharge + altDistanceCharge + altTimeCharge + nightSurcharge;

      const resultText =
        `【バス料金計算】\n` +
        `運行時間: ${driveHours}時間（点検時間含む・最低5時間）\n` +
        `時間制料金: ${driveHours}時間 × ${timeRate}円 = ${timeCharge.toLocaleString()}円\n` +
        `距離制料金: ${totalDistance}km × ${distanceRate}円 = ${distanceCharge.toLocaleString()}円\n` +
        (hasAltDriver
          ? `\n【交代運転者加算】\n` +
            `距離加算: ${totalDistance}km × ${altDistanceRate}円 = ${altDistanceCharge.toLocaleString()}円\n` +
            `時間加算: ${driveHours}時間 × ${altTimeRate}円 = ${altTimeCharge.toLocaleString()}円\n`
          : '') +
        (nightHours > 0
          ? `\n【深夜早朝加算】\n` +
            `対象時間: ${nightHours}時間（22:00〜翌6:00）\n` +
            `(${timeRate}円 + ${altDistanceRate}円) × ${nightHours}h = ${nightBase.toLocaleString()}円\n` +
            `${nightBase.toLocaleString()}円 × 20% = ${nightSurcharge.toLocaleString()}円\n`
          : '') +
        `\n【最終合計】\n${total.toLocaleString()}円`;

      document.getElementById('result').innerText = resultText;
    }
  </script>
</body>
</html>
